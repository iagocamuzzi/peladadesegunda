<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ADM – Lista da Pelada</title>

  <style>
    :root{
      --bg:#0f1216;--card:#141922;--txt:#e7edf6;--muted:#98a7be;
      --border:#222c3a;--ink:#0c1016;--accent:#25D366;--ok:#06d6a0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.25)}

    h1{margin:0 0 10px;font-size:24px}
    .muted{color:var(--muted);margin-bottom:18px;font-size:14px}

    .row{display:flex;gap:20px;flex-wrap:wrap}
    .col{flex:1;min-width:300px}

    ul{list-style:none;padding:0;margin:0;display:grid;gap:8px}
    li{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--ink);transition:all .20s}

    li.is-new{border-color:var(--ok)}
    li.pending::after{
      content:"aguardando";position:absolute;right:12px;top:10px;
      font-size:11px;color:#8ee3c3;border:1px dashed #31785f;
      padding:2px 6px;border-radius:12px;
    }

    .btn{margin-top:12px;padding:12px 16px;width:100%;border:0;
         border-radius:12px;background:var(--accent);color:#0a0f0d;
         font-weight:700;font-size:16px;cursor:pointer}

    #resume{color:var(--muted);margin-top:14px;font-size:14px}
    #log{margin-top:10px;color:var(--muted);font-size:13px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Lista da Pelada – ADM</h1>
    <p class="muted">Os nomes aparecem imediatamente, e são confirmados assim que o CSV atualizar.</p>

    <button id="btnWpp" class="btn">Enviar lista no WhatsApp</button>
    <div id="resume"></div>

    <div style="height:1px;background:var(--border);margin:18px 0"></div>

    <div class="row">
      <div class="col">
        <h3>Titulares (<span id="maxTit">15</span>)</h3>
        <ul id="tit"></ul>
      </div>
      <div class="col">
        <h3>Suplentes</h3>
        <ul id="sup"></ul>
      </div>
    </div>

    <div id="log"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="config.js"></script>

<script>
  const cfg = window.PELADA_CFG || {};
  const CSV_URL = cfg.SHEET_CSV_URL;
  const MAX_TIT = cfg.TITULARES_MAX ?? 15;
  const PRECO = cfg.PRECO || 20;

  let ultimoNome = (sessionStorage.getItem('ultimo_nome_pelada')||'').toUpperCase() || null;
  let pollTimer = null;
  let pollStart = null;

  const normalize = s => (s||"").toString().trim().toUpperCase();
  const parseDate = s => {
    if(!s) return null;
    if(/^\d{2}\/\d{2}\/\d{4}/.test(s)){
      const [d,m,yRest]=s.split('/');
      const [y,t=""]=yRest.split(' ');
      const [hh=0,mm=0,ss=0]=t.split(':').map(Number);
      return new Date(+y,+m-1,+d,hh,mm,ss);
    }
    const t = Date.parse(s);
    return isNaN(t)?null:new Date(t);
  };
  const lastTue = () => {
    const d=new Date(); const dow=d.getDay();
    const diff=(dow>=2?dow-2:7-(2-dow));
    d.setDate(d.getDate()-diff); d.setHours(0,0,0,0);
    return d;
  };

  async function loadCSV(){
    const resp = await fetch(CSV_URL + "&cacheBust="+Date.now());
    const txt = await resp.text();
    const parsed = Papa.parse(txt,{header:true,skipEmptyLines:true});
    const rows = parsed.data.map(r=>{
      const h = Object.keys(r);
      return {time:r[h[0]], name:normalize(r[h[1]])};
    }).filter(r=>r.name);

    const corte = lastTue();
    const filtrados = rows
      .map(r=>({...r, date:parseDate(r.time)}))
      .filter(r=>r.date && r.date>=corte)
      .sort((a,b)=>a.date-b.date);

    return {nomes: filtrados.map(r=>r.name), corte};
  }

  function render(nomes, corte, highlight=null){
    const tit = document.getElementById('tit');
    const sup = document.getElementById('sup');
    tit.innerHTML=""; sup.innerHTML="";

    const titu = nomes.slice(0,MAX_TIT);
    const supl = nomes.slice(MAX_TIT);

    titu.forEach((n,i)=>{
      const li=document.createElement('li');
      li.textContent = (i+1)+"º — "+n;
      if(highlight && n===highlight) li.classList.add("is-new");
      if(n.includes("(AGUARDANDO")) li.classList.add("pending");
      li.style.position="relative";
      tit.appendChild(li);
    });
    supl.forEach((n,i)=>{
      const li=document.createElement('li');
      li.textContent = (i+1)+" — "+n;
      if(highlight && n===highlight) li.classList.add("is-new");
      if(n.includes("(AGUARDANDO")) li.classList.add("pending");
      li.style.position="relative";
      sup.appendChild(li);
    });

    document.getElementById('resume').innerHTML =
      `Total: <b>${nomes.length}</b> &nbsp;|&nbsp; 
       Arrecadado: <b>R$ ${(nomes.length*PRECO).toFixed(2).replace('.',',')}</b>`;

    window._wppMessage = buildMsg(titu, supl, nomes.length);
    document.getElementById("maxTit").textContent = MAX_TIT;
  }

  function buildMsg(tit, sup, tot){
    const L=[];
    L.push("PELADA DE SEGUNDA ⚽\n");
    L.push("Titulares:");
    tit.forEach((n,i)=>L.push((i+1)+". "+n));
    L.push("\nSuplentes:");
    L.push(sup.length?sup.join(", "):"—");
    L.push("\nTotal de jogadores: "+tot);
    L.push("Valor arrecadado: R$ "+(tot*PRECO).toFixed(2).replace('.',','));
    return L.join("\n");
  }

  async function fluxo(){
    const {nomes,corte}=await loadCSV();

    // Se já confirmou
    if(ultimoNome && nomes.includes(ultimoNome)){
      render(nomes,corte,ultimoNome);
      sessionStorage.removeItem('ultimo_nome_pelada');
      ultimoNome=null;
      return;
    }

    // Inserir provisório
    if(ultimoNome && !nomes.includes(ultimoNome)){
      const tmp = nomes.slice();
      tmp.push(`${ultimoNome} (aguardando)`);
      render(tmp,corte,null);

      startPolling();
    } else {
      render(nomes,corte,null);
    }
  }

  function startPolling(){
    pollStart = Date.now();
    pollTimer = setInterval(async ()=>{
      const {nomes,corte} = await loadCSV();

      if(nomes.includes(ultimoNome)){
        clearInterval(pollTimer);
        pollTimer=null;
        sessionStorage.removeItem('ultimo_nome_pelada');
        render(nomes,corte,ultimoNome);
        ultimoNome=null;
        return;
      }

      if(Date.now()-pollStart > 30000){
        clearInterval(pollTimer);
        pollTimer=null;
        document.getElementById('log').textContent =
          "CSV não atualizou ainda. Tente novamente em alguns segundos.";
      }
    },3000);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("btnWpp").onclick = ()=>{
      const link="https://wa.me/?text="+encodeURIComponent(window._wppMessage||"");
      window.open(link,"_blank");
    };
    fluxo();
  });
</script>

</body>
</html>
