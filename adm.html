<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ADM – Lista da Pelada</title>
  <style>
    :root{
      --bg:#0f1216;--card:#141922;--txt:#e7edf6;--muted:#98a7be;
      --border:#222c3a;--ink:#0c1016;--accent:#25D366;--ok:#06d6a0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 10px;font-size:24px}
    .muted{color:var(--muted);margin-bottom:18px;font-size:14px}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .col{flex:1;min-width:300px}
    ul{list-style:none;padding:0;margin:0;display:grid;gap:8px}
    li{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--ink);display:flex;justify-content:space-between;align-items:center}
    li.is-new{border-color:var(--ok)}
    #resume{color:var(--muted);margin-top:14px;font-size:14px}
    .btn{margin-top:12px;padding:12px 16px;width:100%;border:0;border-radius:12px;background:var(--accent);color:#0a0f0d;font-weight:700;font-size:16px;cursor:pointer}
  </style>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Lista da Pelada de Segunda</h1>
    <p class="muted">Atualização da Lista</p>

    <button id="btnWpp" class="btn">Enviar lista no WhatsApp</button>
    <div id="resume"></div>

    <div style="height:1px;background:var(--border);margin:18px 0"></div>

    <div class="row">
      <div class="col">
        <h3>Titulares (<span id="maxTit">15</span>)</h3>
        <ul id="tit"></ul>
      </div>
      <div class="col">
        <h3>Suplentes</h3>
        <ul id="sup"></ul>
      </div>
    </div>
  </div>
</div>

<script src="config.js?cb=1"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const FALLBACK = {
    FIREBASE: {
      apiKey: "AIzaSyBHkn2f20TbpaZ0oU4nKt91O-4hxl8M780",
      authDomain: "pelad-segunda.firebaseapp.com",
      projectId: "pelad-segunda",
      storageBucket: "pelad-segunda.firebasestorage.app",
      messagingSenderId: "346189760762",
      appId: "1:346189760762:web:f52ca3de59f5d4c750e143"
    },
    COLLECTION: "inscricoes",
    TITULARES_MAX: 15,
    PRECO: 20,
    ADMIN_MODE: false
  };

  const G = window.PELADA_CFG || {};
  const CFG = {
    FIREBASE: (G.FIREBASE && G.FIREBASE.apiKey) ? G.FIREBASE : FALLBACK.FIREBASE,
    COLLECTION: G.COLLECTION || FALLBACK.COLLECTION,
    TITULARES_MAX: G.TITULARES_MAX ?? FALLBACK.TITULARES_MAX,
    PRECO: G.PRECO ?? FALLBACK.PRECO,
    ADMIN_MODE: !!G.ADMIN_MODE
  };

  console.log("CFG usado em adm.html:", CFG);

  document.getElementById('maxTit').textContent = CFG.TITULARES_MAX;

  const app = initializeApp(CFG.FIREBASE);
  const db  = getFirestore(app);
  const col = collection(db, CFG.COLLECTION);

  let ultimoNome = sessionStorage.getItem('ultimo_nome_pelada') || null;

  function render(players){
    const titUL = document.getElementById('tit');
    const supUL = document.getElementById('sup');
    titUL.innerHTML=""; supUL.innerHTML="";

    const ordenado = players.sort((a,b)=>{
      const ta = a.createdAt?.toMillis?.() || 0;
      const tb = b.createdAt?.toMillis?.() || 0;
      if(ta !== tb) return ta - tb;
      return a.nome.localeCompare(b.nome);
    });

    const titulares = ordenado.slice(0, CFG.TITULARES_MAX);
    const suplentes = ordenado.slice(CFG.TITULARES_MAX);

    titulares.forEach((p,i)=>{
      const li = document.createElement("li");
      li.textContent = `${i+1}º — ${p.nome}`;
      if(ultimoNome && p.nome === ultimoNome) li.classList.add('is-new');
      titUL.appendChild(li);
    });

    suplentes.forEach((p,i)=>{
      const li = document.createElement("li");
      li.textContent = `${i+1} — ${p.nome}`;
      if(ultimoNome && p.nome === ultimoNome) li.classList.add('is-new');
      supUL.appendChild(li);
    });

    const total = ordenado.length;
    document.getElementById('resume').innerHTML =
      `Total: <b>${total}</b> — Arrecadado: R$ ${(total*CFG.PRECO).toFixed(2).replace('.',',')}`;

    window._wppMessage =
      "PELADA DE SEGUNDA ⚽\n\nTitulares:\n" +
      titulares.map((p,i)=>`${i+1}. ${p.nome}`).join("\n") +
      "\n\nSuplentes:\n" +
      (suplentes.length ? suplentes.map(p=>p.nome).join(", ") : "—") +
      `\n\nTotal: ${total}\nValor arrecadado: R$ ${(total*CFG.PRECO).toFixed(2).replace('.',',')}`;
  }

  const q = query(col, orderBy("createdAt","asc"));
  onSnapshot(q, snap=>{
    const arr = [];
    snap.forEach(doc=>{
      const data = doc.data() || {};
      arr.push({
        nome: (data.nome||"").toString().toUpperCase(),
        createdAt: data.createdAt || null
      });
    });

    render(arr);

    if(ultimoNome && arr.some(p=>p.nome===ultimoNome)){
      sessionStorage.removeItem('ultimo_nome_pelada');
      ultimoNome = null;
    }
  });

  document.getElementById("btnWpp").onclick = ()=>{
    const link = "https://wa.me/?text=" + encodeURIComponent(window._wppMessage||"");
    window.open(link, "_blank");
  };
</script>
</body>
</html>
