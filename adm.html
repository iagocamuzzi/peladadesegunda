<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ADM – Lista da Pelada</title>
  <style>
    :root{--bg:#0f1216;--card:#141922;--txt:#e7edf6;--muted:#98a7be;--accent:#25D366}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #222c3a;border-radius:14px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 6px;font-size:24px}
    .muted{color:var(--muted);font-size:14px;margin:0 0 14px}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    ul{list-style:none;padding:0;margin:0;display:grid;gap:8px}
    li{padding:10px 12px;border:1px solid #2a3444;border-radius:12px;background:#0c1016}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #2a3444;background:#0c1016;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:1px solid #2a3444;background:#0c1016;color:var(--txt);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#3a4b64}
    #log{margin-top:8px;color:var(--muted);font-size:13px}
    .divider{height:1px;background:#222c3a;margin:16px 0}
    .tag{font-size:12px;color:#b0c3e6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Pelada de Segunda – Administração</h1>
      <p class="muted">A lista atualiza automaticamente. Após inserir um nome, ele aparece na hora com a marca <span class="tag">(aguardando confirmação)</span> e é validado assim que o CSV do Google atualizar.</p>

      <div class="actions">
        <button id="btnReload" class="btn">Atualizar</button>
        <button id="btnCopy" class="btn">Copiar texto</button>
        <button id="btnWpp" class="btn">Abrir no WhatsApp</button>
        <span id="resume" class="pill"></span>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="col">
          <h3>Titulares (<span id="maxTit">15</span>)</h3>
          <ul id="tit"></ul>
        </div>
        <div class="col">
          <h3>Suplentes</h3>
          <ul id="sup"></ul>
        </div>
      </div>

      <div id="log"></div>
    </div>
  </div>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="config.js"></script>
  <script>
    let _pollTimer = null;
    let _pollStart = null;
    let _ultimoNome = null;

    function lastTuesdayStart(d=new Date()){
      const dt=new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const dow = dt.getDay(); // 0=Dom, 2=Ter
      const diff = (dow >= 2) ? dow-2 : (7 - (2-dow));
      dt.setDate(dt.getDate() - diff);
      dt.setHours(0,0,0,0);
      return dt;
    }

    function parseDateAny(s){
      if(!s) return null;
      if(/\d{2}\/\d{2}\/\d{4}/.test(s)){
        const [d,m,yRest]=s.split('/');
        const [y,time]=(yRest||'').split(' ');
        let h=0,mi=0,se=0;
        if(time){ [h,mi,se]=time.split(':').map(Number); }
        return new Date(Number(y), Number(m)-1, Number(d), h||0, mi||0, se||0);
      }
      const t = Date.parse(s);
      return isNaN(t) ? null : new Date(t);
    }

    function buildMessage(nomeTit, nomeSup, total, preco){
      const linhas = [];
      linhas.push("PELADA DE SEGUNDA ⚽\n");
      linhas.push("");
      linhas.push("Jogadores:");
      nomeTit.forEach((n,i)=> linhas.push((i+1)+". "+n));
      linhas.push("");
      linhas.push("SUPLENTES:");
      linhas.push(nomeSup.length ? nomeSup.join(", ") : "—");
      linhas.push("");
      linhas.push("Total de pagantes: "+total);
      linhas.push("Valor arrecadado: R$ "+(total*preco).toFixed(2).replace('.',','));
      return linhas.join("\n");
    }

    async function loadCSV(){
      const cfg = window.PELADA_CFG || {};
      const maxTit = cfg.TITULARES_MAX ?? 15;
      document.getElementById('maxTit').textContent = maxTit;

      const url = (cfg.SHEET_CSV_URL || cfg.SHEET_CSV_URL_NOMES || '').trim();
      if(!url){
        document.getElementById('log').textContent = "SHEET_CSV_URL (ou *_NOMES) não definido em config.js";
        return {nomesOrdenados: []};
      }

      const resp = await fetch(url + (url.includes('?')?'&':'?') + 'cacheBust=' + Date.now(), { cache: 'no-store' });
      const text = await resp.text();

      // Esperando CSV com cabeçalho: 1ª coluna = timestamp, 2ª coluna = nome
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});

      const rows = parsed.data.map(r=>{
        const headers = Object.keys(r);
        const time = r[headers[0]];
        const name = r[headers[1]];
        return {time, name};
      }).filter(x=> (x.name||'').toString().trim().length>0);

      const corte = lastTuesdayStart();
      const filtrados = rows
        .map(r=>({ ...r, date: parseDateAny(r.time) }))
        .filter(r=> r.date && r.date >= corte)
        .sort((a,b)=> a.date - b.date);

      const nomesOrdenados = filtrados.map(r=> r.name.toString().trim().toUpperCase());

      renderLista(nomesOrdenados, corte);
      return {nomesOrdenados, corte};
    }

    function renderLista(nomesOrdenados, corte){
      const titUL = document.getElementById('tit');
      const supUL = document.getElementById('sup');
      titUL.innerHTML = ""; supUL.innerHTML = "";

      const max = (window.PELADA_CFG?.TITULARES_MAX||15);
      const titulares = nomesOrdenados.slice(0, max);
      const suplentes  = nomesOrdenados.slice(max);

      titulares.forEach((n,i)=>{
        const li=document.createElement('li');
        li.textContent = (i+1)+"º — "+n;
        titUL.appendChild(li);
      });
      suplentes.forEach((n,i)=>{
        const li=document.createElement('li');
        li.textContent = (i+1)+" — "+n;
        supUL.appendChild(li);
      });

      const total = nomesOrdenados.length;
      const preco = window.PELADA_CFG?.PRECO || 20;
      document.getElementById('resume').innerHTML =
        "<b>Total:</b> "+total+
        " | <b>Arrecadado:</b> R$ "+(total*preco).toFixed(2).replace('.',',')+
        " | <b>Desde:</b> "+corte.toLocaleDateString() + " 00:00";

      const textWpp = buildMessage(titulares, suplentes, total, preco);
      window._wppMessage = textWpp;
    }

    function inserirProvisorioSeNecessario(nomesAtual){
      if(!_ultimoNome) return false;
      const jaTem = nomesAtual.includes(_ultimoNome);
      if(jaTem) return false;

      // mostra provisório ao final; visual imediato
      const nomesComTmp = nomesAtual.slice();
      nomesComTmp.push(_ultimoNome + " (aguardando confirmação)");

      const corte = lastTuesdayStart();
      renderLista(nomesComTmp, corte);
      return true;
    }

    async function refreshComPolling(){
      // 1ª carga
      const {nomesOrdenados} = await loadCSV();

      // 2) se não confirmou ainda, exibe provisório e inicia polling
      const precisaProvisorio = inserirProvisorioSeNecessario(nomesOrdenados);
      if(!precisaProvisorio){
        // já confirmou -> limpar storage
        sessionStorage.removeItem('ultimo_nome_pelada');
        return;
      }

      // polling a cada 3s por até 30s
      _pollStart = Date.now();
      _pollTimer = setInterval(async ()=>{
        const {nomesOrdenados: lista} = await loadCSV();

        if(lista.includes(_ultimoNome)){
          clearInterval(_pollTimer);
          _pollTimer = null;
          sessionStorage.removeItem('ultimo_nome_pelada');
          document.getElementById('log').textContent = "Nome confirmado ✅";
          return;
        }
        if(Date.now() - _pollStart > 30000){
          clearInterval(_pollTimer);
          _pollTimer = null;
          document.getElementById('log').textContent =
            "CSV ainda não atualizou. Clique em Atualizar mais tarde.";
        }
      }, 3000);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      _ultimoNome = (sessionStorage.getItem('ultimo_nome_pelada')||'').toUpperCase() || null;

      document.getElementById('btnWpp').onclick = ()=>{
        const link = "https://wa.me/?text=" + encodeURIComponent(window._wppMessage||'');
        window.open(link, "_blank");
      };
      document.getElementById('btnCopy').onclick = async ()=>{
        try{ await navigator.clipboard.writeText(window._wppMessage||''); 
          document.getElementById('log').textContent = "Texto copiado ✅";
        }catch(e){
          document.getElementById('log').textContent = "Não foi possível copiar (segurança do navegador).";
        }
      };
      document.getElementById('btnReload').onclick = ()=> loadCSV();

      refreshComPolling();
    });
  </script>
</body>
</html>
