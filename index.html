<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pelada de Segunda ⚽</title>
  <style>
    :root{--bg:#0f1216;--card:#141922;--muted:#8ea5c2;--txt:#e7edf6;--accent:#25D366;--warn:#ffcc00;--red:#ff4d4f}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:var(--bg); color:var(--txt)}
    .wrap{max-width:760px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:22px;margin:0}
    .card{background:var(--card);border:1px solid #222c3a;border-radius:14px;padding:16px;margin-top:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=text]{flex:1;min-width:220px;padding:12px 14px;border-radius:10px;border:1px solid #293447;background:#0d1117;color:var(--txt)}
    button{cursor:pointer;border:0;border-radius:10px;padding:12px 16px;font-weight:600}
    .btn{background:#2b3546;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-accent{background:var(--accent);color:#06230f}
    .btn-warn{background:var(--warn);color:#2b2100}
    .muted{color:var(--muted);font-size:13px}
    .list{display:grid;grid-template-columns:1fr;gap:10px}
    .section{margin-top:10px}
    .section h3{margin:0 0 8px;font-size:16px;color:#cfe1ff}
    ol,ul{margin:0;padding-left:20px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1320;border:1px solid #293447;font-size:12px;color:#cde}
    .statline{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .danger{color:var(--red)}
    .sep{height:1px;background:#263244;margin:16px 0}
    .time{opacity:.9;font-variant-numeric:tabular-nums}
    footer{margin:24px 0;color:#98a7be;font-size:12px;text-align:center}
    .small{font-size:12px;color:#9fb0c9}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Pelada de Segunda ⚽</h1>
      <div class="row">
        <a class="pill" id="payLink" target="_blank" rel="noreferrer">Pagar PIX (Mercado Pago)</a>
        <span class="pill" id="weekInfo">Semana: —</span>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <input id="nome" type="text" placeholder="Seu NOME (em maiúsculas)" oninput="this.value=this.value.toUpperCase()" />
        <button class="btn" id="btnEuPaguei">Eu paguei</button>
        <button class="btn-warn" id="btnReset">Resetar (terça-feira)</button>
      </div>
      <p class="muted small" style="margin-top:8px">Fluxo simples: pague no link do Mercado Pago → volte aqui → clique em “Eu paguei”. A ordem é pelo horário (HH:MM:SS). Terça-feira a lista zera.</p>
      <div class="sep"></div>
      <div class="statline">
        <span class="pill" id="statTotal">Pagantes: 0</span>
        <span class="pill" id="statValor">Arrecadado: R$ 0</span>
        <span class="pill" id="statTitulares">Titulares (até 15)</span>
      </div>
    </div>

    <div class="card list">
      <div class="section">
        <h3>Jogadores (Titulares)</h3>
        <ol id="listaTitulares"></ol>
      </div>
      <div class="section">
        <h3>Suplentes</h3>
        <ul id="listaSuplentes"></ul>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn-accent" id="btnWhats">Enviar lista no WhatsApp</button>
        <span class="muted small">A mensagem abre pronta para você colar no grupo.</span>
      </div>
    </div>

    <footer>
      <div class="small">Feito para facilitar sua pelada. Sem login, sem backend. Usa Google Forms + Planilha publicada.</div>
    </footer>
  </div>

<script>
/******************** CONFIG ********************/
const CONFIG = {
  MERCADO_PAGO_LINK: 'https://mpago.la/28GhoK6', // seu link curto
  PRECO: 20,
  TITULARES_MAX: 15,
  // 1) Cole a URL de resposta do Google Forms (formResponse)
  //    Ex.: https://docs.google.com/forms/d/e/FORM_ID/formResponse
  GOOGLE_FORM_ACTION: 'COLE_AQUI_URL_formResponse',
  // 2) Descubra o ID do campo "Nome" (entry.xxxxxxxxx)
  GOOGLE_FORM_ENTRY_NAME: 'entry.1234567890',
  // 3) Publicar a aba de respostas da Planilha (Arquivo > Publicar na Web > CSV)
  //    Cole a URL CSV aqui:
  SHEET_CSV_URL: 'COLE_AQUI_URL_DO_CSV_PUBLICADO',
};

/***************** UTIL: terça-feira 00:00 *****************/
function getThisTuesdayStart() {
  const now = new Date();
  // Considera horário local do navegador (Brasil -03)
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const day = d.getDay(); // 0=Dom,1=Seg,2=Ter,...
  const diffToTue = (day >= 2) ? day - 2 : 7 - (2 - day); // quantos dias desde a última terça
  const tue = new Date(d);
  tue.setDate(d.getDate() - diffToTue);
  // zera hora
  tue.setHours(0,0,0,0);
  return tue; // última terça 00:00
}

function fmtTimeWithSeconds(isoOrDate){
  const d = (typeof isoOrDate === 'string') ? new Date(isoOrDate) : isoOrDate;
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}

function weekLabel(date){
  const t = getThisTuesdayStart();
  const end = new Date(t); end.setDate(t.getDate()+6);
  const fmt = (dt)=> dt.toLocaleDateString('pt-BR',{timeZone:'America/Sao_Paulo'});
  return `${fmt(t)} a ${fmt(end)}`;
}

/***************** Estado *****************/
let rows = []; // {nome, dataISO}

async function fetchCSV(url){
  const r = await fetch(url, { cache: 'no-store' });
  const txt = await r.text();
  return txt;
}

function parseCSV(text){
  // Assumimos cabeçalhos: Timestamp, Nome  (o Google Forms cria assim)
  // Se sua planilha tiver outra ordem, ajuste aqui.
  const lines = text.split(/\r?\n/).filter(Boolean);
  const header = lines.shift();
  const out = [];
  for(const line of lines){
    const parts = line.split(',');
    if(parts.length < 2) continue;
    // Timestamp do Forms (coluna 0), Nome (coluna 1)
    const ts = parts[0].trim();
    const nome = parts.slice(1).join(',').trim(); // caso o nome tenha vírgula
    const when = new Date(ts);
    if(!isNaN(when)) out.push({ nome: nome.toUpperCase(), dataISO: when.toISOString(), when });
  }
  return out;
}

function filterThisWeek(list){
  const t0 = getThisTuesdayStart();
  return list.filter(r => new Date(r.dataISO) >= t0);
}

function sortByTimeAsc(list){
  return list.sort((a,b)=> new Date(a.dataISO) - new Date(b.dataISO));
}

function render(){
  const titulares = rows.slice(0, CONFIG.TITULARES_MAX);
  const suplentes = rows.slice(CONFIG.TITULARES_MAX);

  const ol = document.getElementById('listaTitulares');
  const ul = document.getElementById('listaSuplentes');
  ol.innerHTML = '';
  ul.innerHTML = '';

  titulares.forEach((r, i)=>{
    const li = document.createElement('li');
    const t = fmtTimeWithSeconds(r.when);
    li.innerHTML = `${i+1}. <span class="time">${t}</span> — ${r.nome}`;
    ol.appendChild(li);
  });

  suplentes.forEach(r=>{
    const li = document.createElement('li');
    const t = fmtTimeWithSeconds(r.when);
    li.innerHTML = `<span class="time">${t}</span> — ${r.nome}`;
    ul.appendChild(li);
  });

  // Stats
  const total = rows.length;
  document.getElementById('statTotal').textContent = `Pagantes: ${total}`;
  document.getElementById('statValor').textContent = `Arrecadado: R$ ${total * CONFIG.PRECO}`;
  document.getElementById('statTitulares').textContent = `Titulares: ${titulares.length}/${CONFIG.TITULARES_MAX}`;
}

function buildWhatsText(){
  const titulares = rows.slice(0, CONFIG.TITULARES_MAX);
  const suplentes = rows.slice(CONFIG.TITULARES_MAX);

  const tit = titulares.map((r,i)=> `${i+1}. ${r.nome} (${fmtTimeWithSeconds(r.when)})`).join('\n') || '—';
  const sup = suplentes.map(r=> `${r.nome} (${fmtTimeWithSeconds(r.when)})`).join('\n') || '—';
  const total = rows.length;
  const arrec = total * CONFIG.PRECO;
  return `PELADA DE SEGUNDA ⚽\n\nJogadores:\n${tit}\n\nSUPLENTES:\n${sup}\n\nTotal de pagantes: ${total}\nValor arrecadado: R$ ${arrec}`;
}

async function refresh(){
  try{
    document.getElementById('weekInfo').textContent = 'Semana: ' + weekLabel(new Date());
    const csv = await fetchCSV(CONFIG.SHEET_CSV_URL);
    let all = parseCSV(csv);
    all = filterThisWeek(all);
    rows = sortByTimeAsc(all);
    render();
  }catch(e){
    console.error(e);
    alert('Não foi possível carregar a lista. Verifique a URL do CSV publicado.');
  }
}

/***************** Submissão para Google Forms *****************/
function submitToGoogleForms(nome){
  return new Promise((resolve)=>{
    const form = document.createElement('form');
    form.action = CONFIG.GOOGLE_FORM_ACTION;
    form.method = 'POST';
    form.target = 'hidden_iframe';

    const input = document.createElement('input');
    input.type = 'text';
    input.name = CONFIG.GOOGLE_FORM_ENTRY_NAME;
    input.value = nome;

    form.appendChild(input);
    document.body.appendChild(form);

    // cria iframe oculto para não sair da página
    let iframe = document.getElementById('hidden_iframe');
    if(!iframe){
      iframe = document.createElement('iframe');
      iframe.name = 'hidden_iframe';
      iframe.id = 'hidden_iframe';
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
    }

    iframe.onload = () => {
      setTimeout(()=> resolve(true), 800); // dá um tempinho para o Sheets gravar
    };

    form.submit();
    setTimeout(()=> resolve(true), 1500); // fallback
  });
}

/***************** Ações *****************/
async function handleEuPaguei(){
  const el = document.getElementById('nome');
  const nome = (el.value || '').trim().toUpperCase();
  if(!nome){ alert('Digite seu NOME.'); return; }
  if(CONFIG.GOOGLE_FORM_ACTION.includes('COLE_AQUI') || CONFIG.SHEET_CSV_URL.includes('COLE_AQUI')){
    alert('Configure a URL do Google Forms e a URL do CSV publicado nas constantes.');
    return;
  }
  document.getElementById('btnEuPaguei').disabled = true;
  await submitToGoogleForms(nome);
  await new Promise(r=> setTimeout(r, 1200));
  await refresh();
  el.value = '';
  document.getElementById('btnEuPaguei').disabled = false;
}

function handleWhats(){
  const text = encodeURIComponent(buildWhatsText());
  window.open('https://wa.me/?text='+text, '_blank');
}

function handleReset(){
  const today = new Date();
  if(today.getDay() !== 2){
    if(!confirm('Reset recomendado às terças. Tem certeza que deseja continuar?')) return;
  }
  // Como estamos sem backend, o reset "visual" é feito filtrando a partir da terça atual.
  // Para limpar respostas antigas de fato, entre na planilha e apague as linhas.
  refresh();
}

/***************** Init *****************/
(function init(){
  document.getElementById('payLink').href = CONFIG.MERCADO_PAGO_LINK;
  document.getElementById('btnEuPaguei').addEventListener('click', handleEuPaguei);
  document.getElementById('btnWhats').addEventListener('click', handleWhats);
  document.getElementById('btnReset').addEventListener('click', handleReset);
  refresh();
})();
</script>
</body>
</html>
